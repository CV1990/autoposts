# Llama al Worker AutoPosts (solo manual; sin cron automático).
# Configura en GitHub: Settings > Secrets and variables > Actions:
#   WORKER_RUN_URL: URL del Worker + /run (ej. https://autoposts.<account>.workers.dev/run)
#   CRON_SECRET: mismo valor que el secret CRON_SECRET del Worker (para autorizar la llamada)
# Para ejecutar: pestaña Actions → AutoPosts Cron → Run workflow

name: AutoPosts Cron

on:
  workflow_dispatch: # Solo ejecución manual desde la pestaña Actions

jobs:
  trigger-worker:
    runs-on: ubuntu-latest
    steps:
      - name: Llamar al Worker AutoPosts
        run: |
          URL="${{ secrets.WORKER_RUN_URL }}"
          SECRET="${{ secrets.CRON_SECRET }}"
          if [ -z "$URL" ] || [ -z "$SECRET" ]; then
            echo "Faltan WORKER_RUN_URL o CRON_SECRET en los secrets del repositorio."
            exit 1
          fi
          RESP=$(curl -sS -w "\n%{http_code}" "${URL}?secret=${SECRET}")
          HTTP_CODE=$(echo "$RESP" | tail -n1)
          BODY=$(echo "$RESP" | sed '$d')
          echo "HTTP $HTTP_CODE"
          echo "$BODY"
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Worker ejecutado correctamente."
          else
            echo "Worker devolvió error."
            exit 1
          fi
